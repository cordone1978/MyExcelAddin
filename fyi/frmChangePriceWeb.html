
Option Explicit

' 公共变量
Public foundCell As Range
Public g_WhatKind As String

Private IsInitialized As Boolean ' 标记是否已初始化
Private isInitializing As Boolean   ' 正在初始化的标志，防止触发事件

' 用于存储反推出来的价格，以便在后续调用中重用
Private storedMaterialValue As Variant ' 使用 Variant 以便存储 Empty
Private storedCraftValue As Variant    ' 使用 Variant 以便存储 Empty

Private curMaterialValue As Double
Private curCraftValue As Double
Private curStandardValue As Double

Private currentBasePrice As Double

Private hasMaterial As Boolean
Private hasCraft As Boolean


Private Sub cmdOK_Click()
    
    If foundCell Is Nothing Then Exit Sub
    
    '从数据库读取相应的数据更新，目前的情况应该是更新整个项目
    Dim totalValue As String

    ' 直接获取数值
    totalValue = Me.lblRefreshedPriceShow.Caption
    
    If g_WhatKind = COMPONENT_KIND_OUTSOURCED Then
        ' 更新相应的D E F列数据
        '  使用全局变量中的数据写入单元格
        If g_IsPriceChanged Then
            Application.EnableEvents = False
            FillCellsWithData foundCell, g_CallbackData  ' 传递全局变量
            Application.EnableEvents = True
        Else
            MsgBox "没有价格需要更新", , "通知"
            Exit Sub
        End If
    Else
        If totalValue = "" Then
            MsgBox "没有价格需要更新", , "通知"
            Exit Sub
        Else
            Application.EnableEvents = False
            FillCellsWithData foundCell, g_CallbackData  ' 传递全局变量
            Application.EnableEvents = True
        End If
    End If
        
    Me.Hide
End Sub


Private Sub cmdCancel_Click()
    Me.Hide
    ForceExcelRedraw
End Sub


Private Sub ComboBoxMetiral_Change()
    On Error GoTo ErrorHandler
    
    If isInitializing Then Exit Sub

    ' 获取当前选中的索引和值
    Dim selectedIndex As Long
    Dim selectedValue As String
    selectedIndex = Me.ComboBoxMetiral.ListIndex
    selectedValue = Me.ComboBoxMetiral.value
    
    ' 如果没有选中任何项或者选中的是提示项（如 "请选择..."）
    If selectedIndex < 0 Or selectedValue = "请选择..." Then
        ' 清空价格显示标签
        Me.lblMaterialsShow.Caption = ""
        Exit Sub
    End If

    ' 遍历 g_MaterialsConfigData 集合查找匹配的 material_type
    Dim i As Long
    Dim dataArray As Variant
    Dim materialType As String
    Dim totalPrice As Variant
    
    ' 假设 g_MaterialsConfigData 是一个 Collection，其中每个元素是一个数组
    ' 数组结构: [0] material_id, [1] product_id, [2] component_id, [3] material_type, [4] totalprice
    If Not g_MaterialsConfigData Is Nothing Then
        For i = 1 To g_MaterialsConfigData.count
            dataArray = g_MaterialsConfigData(i)
            
            ' 检查是否为数组且至少有5个元素 (索引 0 to 4)
            If IsArray(dataArray) And UBound(dataArray) >= 4 Then
                ' 获取数组中 material_type 的值 (索引 3)
                materialType = CStr(dataArray(3))
                
                ' 检查 material_type 是否与 ComboBox 选中的值匹配 (不区分大小写)
                If StrComp(Trim(materialType), Trim(selectedValue), vbTextCompare) = 0 Then
                    ' 找到匹配项，获取其 totalprice (索引 4)
                    totalPrice = dataArray(4)
                    
                    ' 处理总价可能为空的情况
                    If IsEmpty(totalPrice) Or IsNull(totalPrice) Then
                        Me.lblMaterialsShow.Caption = ""
                    Else
                        ' 尝试将总价格式化为两位小数的字符串显示
                        On Error Resume Next
                            Me.lblMaterialsShow.Caption = Format(CDec(totalPrice), "0")
                        On Error GoTo 0
                        ' 如果 Format 或 CDec 出错（例如，totalPrice 不是数字），则显示原始值
                        If Err.Number <> 0 Then
                            Me.lblMaterialsShow.Caption = CStr(totalPrice)
                            Err.Clear
                        End If
                    End If
                    
                    curMaterialValue = totalPrice
                    hasMaterial = True
                    ' 更新到数据到g_CallbackData
                    g_CallbackData.Material = Trim(materialType)
                    
                    ' 更新总价格
                    UpdateTotalPrice
                    ' 找到匹配项后退出循环
                    Exit Sub
                End If
            End If
        Next i
    End If
    
    ' 如果循环结束后仍未找到匹配项（理论上不应该发生，因为 ComboBox 的值来自 g_MaterialsConfigData）
    ' 或者 g_MaterialsConfigData 为 Nothing
    ' 清空价格显示标签
    Me.lblMaterialsShow.Caption = ""
    Debug.Print "警告：在 g_MaterialsConfigData 中未找到材质 '" & selectedValue & "' 对应的价格。"
    
    Exit Sub

ErrorHandler:
    ' 错误处理：显示错误信息并清空标签
    Debug.Print "ComboBoxMetiral_Change 错误: " & Err.Description
    Me.lblMaterialsShow.Caption = "价格获取错误"
End Sub


Private Sub lblCraftChange_Click()
    Dim ws As Worksheet
    Set ws = ActiveSheet

    If g_WhatKind = COMPONENT_KIND_OUTSOURCED Then
        Call SearchStandardMaterial(foundCell, ws, WHERE_CHANGEPRICEWEB)
        
        If Not g_IsPriceChanged Then Exit Sub
        
        ' 更新分项价格和总价格
        With Me.lblCraftChange
            .Caption = Format(modPublicSequence.g_CallbackData.Price, "0")
            .TextAlign = fmTextAlignRight
        End With

        Exit Sub
    End If

    ' 加载并显示自定义窗体
    ShowForm "frmCrafting", foundCell
    
    ' 检查窗体关闭后是否有计算结果
    If g_CalculatedTotalCraftingValue = "" Then Exit Sub
    
    curCraftValue = CDbl(g_CalculatedTotalCraftingValue)
    hasCraft = True
    
    ' 更新总价格
    UpdateTotalPrice

    ' 更新分项价格和总价格
    With Me.lblCraftChange
        .Caption = Format(g_CalculatedTotalCraftingValue, "0")
        .TextAlign = fmTextAlignRight
    End With

End Sub


Private Sub UserForm_Activate()
    On Error GoTo EH

    If Not EnsureFoundCell() Then Exit Sub

    If Not LoadComponentContext() Then Exit Sub

    ApplyModeUI

    ComputePricesAndUpdateUI

    RenderComponentsHtml

    Exit Sub
EH:
    MsgBox "Activate错误: " & Err.Description, vbExclamation
End Sub


Private Function EnsureFoundCell() As Boolean
    EnsureFoundCell = False

    If Not foundCell Is Nothing Then
        EnsureFoundCell = True
        Exit Function
    End If

    If TypeName(Selection) <> "Range" Then
        Me.DeviceModel.Caption = "请先选择一个单元格"
        Exit Function
    End If

    Set foundCell = Selection.Cells(1, 1)
    EnsureFoundCell = True
End Function


Private Function LoadComponentContext() As Boolean
    LoadComponentContext = False

    Dim ws As Worksheet
    Set ws = ActiveSheet

    Dim cellValue As Variant
    cellValue = foundCell.value

    If IsEmpty(cellValue) Or IsNull(cellValue) Then Exit Function

    Me.DeviceModel.Caption = CStr(cellValue)

    Dim cellRow As Long
    cellRow = foundCell.row

    Dim aValue As String, bValue As String
    aValue = Trim(GetCellValue(ws.Cells(cellRow, "A")))
    bValue = Trim(GetCellValue(ws.Cells(cellRow, "B")))

    Set g_SubCategoryData = GetSubCategoryDataFromDefaultTabel(aValue, bValue)
    If g_SubCategoryData Is Nothing Then Exit Function
    If g_SubCategoryData.count = 0 Then Exit Function

    ' 初始化 g_CallbackData
    With g_CallbackData
        .name = foundCell.Offset(0, 0).value
        .Desc = foundCell.Offset(0, 1).value
        .Type = foundCell.Offset(0, 2).value
        .Price = foundCell.Offset(0, 11).value
        .Unit = foundCell.Offset(0, 6).value
        .Brand = foundCell.Offset(0, 4).value
        .Material = foundCell.Offset(0, 3).value
    End With

    Set g_MaterialsConfigData = GetMaterialConfigDataByComponentName(CStr(cellValue))
    Set g_CraftingConfigData = GetCraftingConfigDataByComponentName(CStr(cellValue))

    Call SelectMaterialComboBox(Me.ComboBoxMetiral, g_CallbackData.Material)

    LoadComponentContext = True
End Function


Private Sub ApplyModeUI()
    If g_WhatKind = COMPONENT_KIND_OUTSOURCED Then
        Me.lblCrafting.Caption = "外购价格"
        Me.lblCraftChange.Caption = "点击查询"
        Me.lblMaterail.visible = False
        Me.ComboBoxMetiral.visible = False
        Me.lblRefreshedPrice.visible = False
        Me.lblRefreshedPriceShow.visible = False
    Else
        Me.lblCrafting.Caption = "表面处理"
        Me.lblCraftChange.Caption = "点击更改"
        Me.lblMaterail.visible = True
        Me.ComboBoxMetiral.visible = True
        Me.lblRefreshedPrice.visible = True
        Me.lblRefreshedPriceShow.visible = True
    End If
End Sub


Private Sub ComputePricesAndUpdateUI()
    ' --- 当前价格基准 ---
    If g_CallbackData.Price = "" Then
        currentBasePrice = 0
    Else
        currentBasePrice = CDbl(g_CallbackData.Price)
    End If

    Me.lblCurrentPriceShow.Caption = Format(g_CallbackData.Price, "0")

    ' --- 标准件价格 ---
    Dim standardPriceStr As String
    standardPriceStr = GetComponentFieldValueAsString(IDX_COMPONENT_NAME, COMPONENT_KIND_STANDARD_PART, IDX_COMPONENT_UNITPRICE)

    If IsNumeric(standardPriceStr) And standardPriceStr <> "" Then
        curStandardValue = CDbl(standardPriceStr)
    Else
        curStandardValue = 0
    End If

    ' --- 原材质 / 工艺 ---
    If g_CraftingConfigData.count = 0 Then
        Me.lblMaterialsShow.Caption = ""
        hasMaterial = False
        hasCraft = False
    Else
        curMaterialValue = g_CraftingConfigData(1)(IDX_CRFT_MATERIALS_PRICE)
        Me.lblMaterialsShow.Caption = curMaterialValue
        hasMaterial = True

        curCraftValue = currentBasePrice - curMaterialValue - curStandardValue
        hasCraft = True
    End If

    UpdateTotalPrice
    Me.lblRefreshedPriceShow.Caption = ""
End Sub


Private Sub RenderComponentsHtml()
    Dim wb As Object
    Set wb = Me.Controls("wbComponents").Object

    Dim allComponents As Collection
    Set allComponents = GetAllComponents(g_SubCategoryData)

    Dim initialSelected As New Collection
    initialSelected.Add CStr(foundCell.value)

    Dim base64Data As Dictionary
    Set base64Data = GetAllComponentImages_Cached(allComponents)

    Dim html As String
    html = BuildHTMLContent(allComponents, base64Data, wb.Width, wb.Height, initialSelected, True)

    LoadHTMLToWebBrowser wb, html
End Sub


' 只初始化UI，不加载数据
Private Sub UserForm_Initialize()
    On Error GoTo ErrorHandler

    isInitializing = True

    Me.wbComponents.Navigate "about:blank"

    Me.Caption = "组件内容变更"
    Me.DeviceModel.Caption = "设备组件"

    ' 初始化材质listbox
    With Me.ComboBoxMetiral
        .Clear
        .AddItem ""

        ' 设置默认选中第一项
        .ListIndex = 0

        ' 可选：设置样式属性
        .style = fmStyleDropDownList ' 仅选择，不能输入
    End With

    isInitializing = False
    
    Exit Sub
    
ErrorHandler:
    MsgBox "窗体初始化错误: " & Err.Description, vbExclamation
End Sub


' 专门为材质ComboBox设计的函数
' 功能：根据 g_MaterialsConfigData 的数据填充 ComboBox，
'       并根据 materialValue 尝试匹配选择值，
'       同时将匹配记录的总价显示在 lblmaterialsShow 上。
Private Sub SelectMaterialComboBox(cmb As MSForms.ComboBox, materialValue As String, Optional lblMaterialsShow As MSForms.Label = Nothing)
    On Error GoTo ErrorHandler
    
    ' --- 清空 ComboBox ---
    cmb.Clear
    
    ' --- 检查是否有数据 ---
    If g_MaterialsConfigData Is Nothing Or g_MaterialsConfigData.count = 0 Then
        ' 没有数据，添加提示项
        cmb.AddItem "请选择..."
        cmb.ListIndex = -1 ' 不选择任何项
        ' 清空标签显示
        If Not lblMaterialsShow Is Nothing Then lblMaterialsShow.Caption = ""
        Exit Sub
    End If
    
    ' --- 有数据，遍历 g_MaterialsConfigData 填充 ComboBox ---
    Dim dataCollection As Collection
    Set dataCollection = g_MaterialsConfigData
    
    Dim i As Long
    Dim dataArray As Variant
    Dim materialType As String
    Dim totalPrice As Variant
    
    ' 用于存储找到的匹配项及其总价的临时变量
    Dim matchedMaterialType As String
    Dim matchedTotalPrice As Variant
    Dim foundMatch As Boolean
    foundMatch = False
    
    ' 遍历集合，填充 ComboBox 并寻找匹配项
    For i = 1 To dataCollection.count
        dataArray = dataCollection(i)
        
        ' 检查数组维度和索引是否有效
        If IsArray(dataArray) And UBound(dataArray) >= 4 Then ' 至少有 5 个元素 (0 to 4)
            ' 获取第 4 个字段 (索引 3) - material_type
            materialType = CStr(dataArray(3))
            
            ' 检查 material_type 是否为空
            If Len(Trim(materialType)) > 0 Then
                ' 将 material_type 添加到 ComboBox
                cmb.AddItem materialType
                
                ' 检查是否与传入的 materialValue 匹配
                If Not foundMatch Then ' 只有在还没找到匹配项时才检查
                    ' 这里可以使用精确匹配或其他匹配逻辑，根据需要调整
                    ' 当前使用不区分大小写的精确匹配
                    If StrComp(Trim(materialType), Trim(materialValue), vbTextCompare) = 0 Then
                        ' 找到匹配项，记录其 material_type 和 totalPrice
                        matchedMaterialType = materialType
                        ' 获取第 5 个字段 (索引 4) - totalprice
                        totalPrice = dataArray(4)
                        If IsEmpty(totalPrice) Or IsNull(totalPrice) Then
                            matchedTotalPrice = "" ' 或者可以设置为 0
                        Else
                            ' 尝试格式化为货币字符串，如果失败则保持原样
                            On Error Resume Next
                                matchedTotalPrice = Format(CDec(totalPrice), "0.00")
                            On Error GoTo 0
                            If Err.Number <> 0 Then
                                matchedTotalPrice = CStr(totalPrice) ' 如果格式化失败，用原始字符串
                                Err.Clear
                            End If
                        End If
                        foundMatch = True
                    End If
                End If
            End If
        Else
            Debug.Print "警告：g_MaterialsConfigData 中第 " & i & " 项不是有效的数组或字段数不足。"
        End If
    Next i
    
    ' --- 设置 ComboBox 的选择和标签显示 ---
    If foundMatch Then
        ' 找到了匹配项
        ' 在 ComboBox 中找到匹配的 material_type 的索引并选中
        Dim comboIndex As Long
        For comboIndex = 0 To cmb.ListCount - 1
            If StrComp(cmb.List(comboIndex), matchedMaterialType, vbTextCompare) = 0 Then
                cmb.ListIndex = comboIndex
                Exit For ' 找到后退出循环
            End If
        Next comboIndex
        ' 更新标签显示总价
        If Not lblMaterialsShow Is Nothing Then
            lblMaterialsShow.Caption = matchedTotalPrice
        End If
    Else
        ' 没有找到匹配项
        ' 添加 "请选择..." 项（通常放在开头）
        cmb.AddItem "请选择...", 0 ' 插入到第一个位置
        cmb.ListIndex = 0 ' 选择 "请选择..." 项
        ' 清空标签显示
        If Not lblMaterialsShow Is Nothing Then lblMaterialsShow.Caption = ""
    End If
    
    Exit Sub

ErrorHandler:
    Debug.Print "SelectMaterialComboBox 发生错误: " & Err.Description
    ' 清空控件作为错误处理的一部分（可选）
    cmb.Clear
    cmb.AddItem "加载错误..."
    cmb.ListIndex = 0
    If Not lblMaterialsShow Is Nothing Then lblMaterialsShow.Caption = "错误"
End Sub


Private Sub UpdateTotalPrice()

    Dim total As Double

    total = curStandardValue

    If hasMaterial Then total = total + curMaterialValue
    If hasCraft Then total = total + curCraftValue

    g_CallbackData.Price = total
    
    ' --- 更新总价格显示，并调整字体样式 ---
    With Me.lblRefreshedPriceShow
        .Caption = Format(total, "0")
        .Font.Bold = True ' 字体加粗
        .FontSize = 14 ' 字号加大一号
    End With
End Sub


'Private Sub wbComponents_TitleChange(ByVal Text As String)
'    ' 检查是否是我们定义的通讯消息
'    If InStr(Text, "VBA_CMD|") <> 1 Then Exit Sub
'
'    ' --- 变量声明 ---
'    Dim parts() As String
'    Dim action As String
'
'    ' --- 解析消息 ---
'    ' 格式: "VBA_CMD|Action|Param1|Param2|Random"
'    parts = Split(Text, "|")
'
'    ' 至少需要 "VBA_CMD" 和 "Action" 两个部分
'    If UBound(parts) < 1 Then Exit Sub
'
'    action = parts(1) ' 获取动作指令
'
'    ' --- 根据动作执行不同逻辑 ---
'    Select Case action
'
'        Case "RENDER_COMPLETE"
'            ' 收到 JS 通知：网页内容已渲染完成
'
'
'        Case "DETAIL"
'            ' 收到 JS 通知：用户点击了“查看详情”
'            ' 至少需要 Action, ID, Name 三个参数
'            If UBound(parts) >= 3 Then
'                Dim id As String
'                Dim name As String
'
'                id = parts(2)   ' 组件ID
'                name = parts(3) ' 组件名
'
'                ' 执行您的业务逻辑
'                MsgBox "【VBA收到消息】" & vbCrLf & _
'                       "用户想要查看组件详情：" & vbCrLf & _
'                       "ID: " & id & vbCrLf & _
'                       "名称: " & name, vbInformation, "通讯成功"
'            End If
'
'        Case "GLOBAL_SETTING"
'            ' 收到 JS 通知：用户点击了“系统设置”
'            ' 执行您的业务逻辑
'            MsgBox "打开系统设置窗口...", vbInformation
'
'        ' 可在此处添加更多 Case 来处理其他动作
'        ' Case "ANOTHER_ACTION"
'        '     ...
'
'    End Select
'End Sub

Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)

    ' 方法1：刷新整个Excel应用窗口（推荐）
    Application.ScreenUpdating = False
    Application.ScreenUpdating = True
    
        ' 方法2：强制处理所有消息队列
    DoEvents
End Sub
